---
  # GitHub Actions workflow to upgrade the Helm chart dependencies on our modules.
  #
  # IMPORTANT: This workflow is called by other workflows in our DevOps Stack repositories and it is centralized here in 
  # order to be easily maintained across modules. Because of this, please make sure you're not introducing any breaking 
  # changes when modifying this workflow.
  
  name: "modules-chart-upgrade"
  
  on:
    workflow_call:
      inputs:
        upgrade-strategy:
          description: "Upgrade strategy to use. Valid values are 'major', 'minor' or 'patch'"
          type: string
          required: true
        excluded-dependencies:
          description: "Comma-separated list of dependencies to exclude from upgrade (i.e. 'dependency1,dependency2,dependency3')"
          type: string
          required: false
          default: ""
        dry-run:
          description: "Whether to run the upgrade in dry-run mode or not"
          type: boolean
          required: false
          default: false
      secrets:
        PROJECT_APP_PRIVATE_KEY:
          description: "GitHub App private key for the DevOps Stack Project app"
          required: true

  jobs:
    list-charts:
      runs-on: ubuntu-latest
      outputs:
        charts: ${{ steps.find-charts.outputs.charts }}
      
      steps:
      - name: "Check out the repository"
        uses: actions/checkout@v3
      
      - name: "List charts in the ./charts folder"
        id: find-charts
        run: cd charts && echo "charts=$(find . -maxdepth 2 -name 'Chart.yaml' -exec dirname {} \; | sed 's|^\./||' | sort -u | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT

    chart-upgrade:
      runs-on: ubuntu-latest

      needs: list-charts
      
      # Pass the PR number output to activate the add-pr-to-project job only if a PR is created.
      outputs:
        minor-pr-number: ${{ steps.minor-pr.outputs.pull-request-number }}
        major-pr-number: ${{ steps.major-pr.outputs.pull-request-number }}

      strategy:
        matrix:
          chart-name: ${{ fromJson(needs.list-charts.outputs.charts) }}

      # Define global settings for both PR steps.
      env:
        committer: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

      steps:
      - name: "Check out the repository"
        uses: actions/checkout@v3

      - name: "Upgrade Helm chart dependencies"
        id: deps-upgrade
        uses: camptocamp/helm-dependency-upgrade-action@v0.3.1
        with:
          chart-path: "charts/${{ matrix.chart-name }}"
          readme-path: "README.adoc"
          excluded-dependencies: ${{ inputs.excluded-dependencies }}
          upgrade-strategy: "${{ inputs.upgrade-strategy }}"
          dry-run: "${{ inputs.dry-run }}"

      - name: "Create Pull Request for a minor/patch upgrade"
        if: ${{ !inputs.dry-run && steps.deps-upgrade.outputs.upgrade-type != 'none' && !steps.deps-upgrade.outputs.upgrade-type != 'major' }}
        id: minor-pr
        uses: peter-evans/create-pull-request@v3
        env:
          pr-title: "chore(chart): ${{ steps.deps-upgrade.outputs.upgrade-type }} upgrade of dependencies on ${{ matrix.chart-name }} chart"
          branch: "chart-autoupgrade-${{ steps.deps-upgrade.outputs.upgrade-type }}-${{ matrix.chart-name }}"
          labels: "chart-autoupgrade-${{ steps.deps-upgrade.outputs.upgrade-type }}"

        with:
          commit-message: ${{ env.pr-title }}
          committer: ${{ env.committer }}
          branch: "chart-autoupgrade-${{ steps.deps-upgrade.outputs.upgrade-type }}-${{ matrix.chart-name }}"
          title: ${{ env.pr-title }}
          labels: "chart-autoupgrade-${{ steps.deps-upgrade.outputs.upgrade-type }}"
          body: |
            :robot: I have updated the chart *beep* *boop*
            ---

            ## Description of the changes

            This PR upgrades the dependencies of the **${{ matrix.chart-name }}** Helm chart. The maximum version bump was a **${{ steps.deps-upgrade.outputs.upgrade-type }}**.

      - name: "Create Pull Request for a major upgrade"
        if: ${{ !inputs.dry-run && steps.deps-upgrade.outputs.upgrade-type != 'none' && steps.deps-upgrade.outputs.upgrade-type == 'major' }}
        id: major-pr
        uses: peter-evans/create-pull-request@v3
        env:
          pr-title: "chore!(chart): major upgrade of dependencies on ${{ matrix.chart-name }} chart"
        with:
          commit-message: ${{ env.pr-title }}
          committer: ${{ env.committer }}
          branch: "chart-autoupgrade-major-${{ matrix.chart-name }}"
          title: ${{ env.pr-title }}
          labels: "chart-autoupgrade-major"
          body: |
            :robot: I have updated the chart *beep* *boop*
            ---

            ## Description of the changes

            This PR upgrades the dependencies of the **${{ matrix.chart-name }}** Helm chart. .

            :warning: This was a **major** upgrade!. Please check the changelog of the updated dependencies and take notice of any breaking changes before merging. :warning:

    add-pr-to-project:
      needs: chart-upgrade
      if: ${{ needs.chart-upgrade.outputs.minor-pr-number || needs.chart-upgrade.outputs.major-pr-number }}
      uses: camptocamp/devops-stack/.github/workflows/pr-issues-project.yaml@main
      secrets:
        PROJECT_APP_PRIVATE_KEY: ${{ secrets.PROJECT_APP_PRIVATE_KEY }}
