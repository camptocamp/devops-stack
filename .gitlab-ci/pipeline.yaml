---
variables:
  TERRAFORM_VERSION: "0.13.5"
  CAMPTOCAMP_DEVOPS_STACK_VERSION: "0.12.0"

###
# Pipeline for Merge Requests
#

mr:terraform:plan:
  image:
    name: hashicorp/terraform:$TERRAFORM_VERSION
    entrypoint: [""]
  variables:
    CLUSTER_NAME: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
  script:
    - wget -O- "https://raw.githubusercontent.com/camptocamp/camptocamp-devops-stack/v$CAMPTOCAMP_DEVOPS_STACK_VERSION/scripts/plan.sh" | sh
  allow_failure: true
  rules:
    - if: '$CI_MERGE_REQUEST_ID'

###
# Pipeline for Protected Branches
#

pb:terraform:apply:
  image:
    name: hashicorp/terraform:$TERRAFORM_VERSION
    entrypoint: [""]
  variables:
    CLUSTER_NAME: $CI_COMMIT_REF_NAME
  before_script:
    - mkdir -p "$HOME/bin"
    - wget https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 -O "$HOME/bin/jq"
    - chmod +x "$HOME/bin/jq"
    - wget https://get.helm.sh/helm-v3.4.0-linux-amd64.tar.gz -O -| tar xz linux-amd64/helm -O > "$HOME/bin/helm"
    - chmod +x "$HOME/bin/helm"
    - export PATH="$HOME/bin:$PATH"
  script:
    - wget -O- "https://raw.githubusercontent.com/camptocamp/camptocamp-devops-stack/v$CAMPTOCAMP_DEVOPS_STACK_VERSION/scripts/provision.sh" | sh
  environment:
    name: cluster/$CI_COMMIT_REF_NAME
    on_stop: pb:terraform:destroy
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"'

###
# On-stop action for Gitlab CI environment
#

pb:terraform:destroy:
  image:
    name: hashicorp/terraform:$TERRAFORM_VERSION
    entrypoint: [""]
  variables:
    CLUSTER_NAME: $CI_COMMIT_REF_NAME
  script:
    - wget -O- "https://raw.githubusercontent.com/camptocamp/camptocamp-devops-stack/v$CAMPTOCAMP_DEVOPS_STACK_VERSION/scripts/destroy.sh" | sh
  environment:
    name: cluster/$CI_COMMIT_REF_NAME
    action: stop
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_REF_PROTECTED == "true"'
      when: manual
