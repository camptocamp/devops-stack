:project-name: camptocamp-devops-stack
:url-repo: https://github.com/camptocamp/{project-name}.git
:version: 0.17.0

== Create a new project

[source,shell,subs="attributes"]
----
mkdir myproject
cd myproject
git init
----

== Define which version of the Camptocamp DevOps Stack to use

You can define the version to use for:
- the Gitlab CI pipeline,
- the Terraform composition module,
- the Kubernetes core applications to deploy.

In production system, you should always use the same version for this 3 elements, but it may be convient when testing to change the version of only one of these.

=== Create .gitlab-ci.yml file

[source,shell,subs="attributes"]
----
cat << EOF > .gitlab-ci.yml
---
include:
  - https://raw.githubusercontent.com/camptocamp/camptocamp-devops-stack/v{version}/.gitlab-ci/pipeline.yaml
EOF
----

=== Create Terraform root module

Declare Camptocamp's DevOps Stack's Terraform's composition module:

[source,shell,subs="attributes"]
----
mkdir terraform
cat << EOF > terraform/main.tf
module "cluster" {
  source = "git::{url-repo}//modules/eks-aws?ref=v{version}"

  cluster_name = terraform.workspace
  vpc_id       = data.aws_vpc.this.id

  worker_groups = [
    {
      instance_type        = "m5a.large"
      asg_desired_capacity = 2
      asg_max_size         = 3
    }
  ]

  repo_url        = "{url-repo}"
  target_revision = "v{version}"
}
EOF
----

Gitlab CI's pipeline requires outputs to run `argocd app diff` on merge requests.
Declare required outputs:
[source,shell,subs="attributes"]
----
cat << EOF > terraform/outputs.tf
output "argocd_auth_token" {
  sensitive = true
  value     = module.cluster.argocd_auth_token
}

output "kubeconfig" {
  sensitive = true
  value     = module.cluster.kubeconfig
}

output "repo_url" {
  value = module.cluster.repo_url
}

output "target_revision" {
  value = module.cluster.target_revision
}

output "app_of_apps_values" {
  sensitive = true
  value     = module.cluster.app_of_apps_values
}
EOF
----
