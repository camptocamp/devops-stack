<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploying the DevOps Stack to EKS :: Camptocamp’s DevOps Stack</title>
    <link rel="canonical" href="https://devops-stack.io/camptocamp-devops-stack/camptocamp-devops-stack/0.28.0/howtos/quickstart_eks.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="icon" href="../../../_/img/c2c_favicon.png" type="image/x-icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://devops-stack.io/camptocamp-devops-stack">Camptocamp’s DevOps Stack</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="camptocamp-devops-stack" data-version="0.28.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Camptocamp’s DevOps Stack</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting_started.html">Getting Started</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Howtos</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../quickstart.html">Quickstarts</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="quickstart_eks.html">EKS</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="quickstart_aks.html">AKS</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="quickstart_k3s_docker.html">K3s on Docker</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="quickstart_k3s_libvirt.html">K3s on Libvirt</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#ROOT:howtos/contributions.adoc">Contribution</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="development.html">Development</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="write_documentation.html">Documentation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="release.html">Release a new version</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">References</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../references/authentication.html">Authentication</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../references/changelog.html">Changelog</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Explanations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/purpose.html">Purpose</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/cloud_agnostic.html">Cloud Agnostic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/infrastructure-as-code.html">Infrastructure As Code</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/gitops.html">Continuous Delivery</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/lifecycle_operations.html">Lifecycle Operations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/data_persistence.html">Data Persistence</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/upgrade_strategy.html">Kubernetes Upgrade Strategy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../explanations/documentation.html">Docs as Code</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Camptocamp’s DevOps Stack</span>
    <span class="version">0.28.0</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Antora UI for c2c</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../antora-ui-c2c/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Camptocamp’s DevOps Stack</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">0.28.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Camptocamp’s DevOps Stack</a></li>
    <li>Howtos</li>
    <li><a href="../quickstart.html">Quickstarts</a></li>
    <li><a href="quickstart_eks.html">EKS</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Deploying the DevOps Stack to EKS</h1>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Access to API keys allowing to create required resources in AWS,</p>
</li>
<li>
<p>Access to GitLab or GitHub (only supported CI/CD for now),</p>
</li>
<li>
<p>Knowledge of <a href="https://terraform.io">Terraform</a> basics</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_your_terraform_root_module"><a class="anchor" href="#_create_your_terraform_root_module"></a>Create your Terraform root module</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Camptocamp&#8217;s DevOps stack is a Terraform composition module
has to be instantiated from the Terraform root module.</p>
</div>
<div class="paragraph">
<p>Here is a minimal working example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hcl hljs" data-lang="hcl"># terraform/main.tf

locals {
  cluster_name = "my-cluster"
}

data "aws_availability_zones" "available" {}

module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "2.66.0"

  name = local.cluster_name
  cidr = "10.0.0.0/16"

  azs = data.aws_availability_zones.available.names

  private_subnets = [
    "10.0.1.0/24",
    "10.0.2.0/24",
    "10.0.3.0/24",
  ]

  public_subnets = [
    "10.0.11.0/24",
    "10.0.12.0/24",
    "10.0.13.0/24",
  ]

  # NAT Gateway Scenarios : One NAT Gateway per availability zone
  enable_nat_gateway     = true
  single_nat_gateway     = false
  one_nat_gateway_per_az = true

  enable_dns_hostnames = true
  enable_dns_support   = true

  private_subnet_tags = {
    "kubernetes.io/cluster/default"   = "shared"
    "kubernetes.io/role/internal-elb" = "1"
  }

  public_subnet_tags = {
    "kubernetes.io/role/elb" = "1"
  }
}

module "cluster" {
  source = "git::https://github.com/camptocamp/camptocamp-devops-stack.git//modules/eks/aws?ref=v0.26.0"

  cluster_name = local.cluster_name
  vpc_id       = module.vpc.vpc_id

  worker_groups = [
    {
      instance_type        = "m5a.large"
      asg_desired_capacity = 2
      asg_max_size         = 3
    }
  ]

  base_domain     = "example.com"

  cognito_user_pool_id     = aws_cognito_user_pool.pool.id
  cognito_user_pool_domain = aws_cognito_user_pool_domain.pool_domain.domain
}

resource "aws_cognito_user_pool" "pool" {
  name = "pool"
}

resource "aws_cognito_user_pool_domain" "pool_domain" {
  domain       = "pool-domain"
  user_pool_id = aws_cognito_user_pool.pool.id
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_terraform_outputs"><a class="anchor" href="#_terraform_outputs"></a>Terraform Outputs</h3>
<div class="paragraph">
<p>Define outputs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hcl hljs" data-lang="hcl"># terraform/outputs.tf

output "argocd_auth_token" {
  sensitive = true
  value     = module.cluster.argocd_auth_token
}

output "kubeconfig" {
  sensitive = true
  value     = module.cluster.kubeconfig
}

output "argocd_server" {
  value = module.cluster.argocd_server
}

output "repo_url" {
  value = module.cluster.repo_url
}

output "target_revision" {
  value = module.cluster.target_revision
}

output "app_of_apps_values" {
  sensitive = true
  value     = module.cluster.app_of_apps_values
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_terraform_backend"><a class="anchor" href="#_terraform_backend"></a>Terraform Backend</h3>
<div class="paragraph">
<p>If you wish to
<a href="https://www.terraform.io/docs/language/state/remote.html">collaborate</a>,
define a backend to store your state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-hcl hljs" data-lang="hcl"># terraform/versions.tf

terraform {
  backend "remote" {
    organization = "example_corp"

    workspaces {
      name = "my-app-prod"
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_from_your_workstation"><a class="anchor" href="#_deploying_from_your_workstation"></a>Deploying from your workstation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Even if one of the purpose of the DevOps Stack is to do everything in pipelines,
you could deploy your cluster from your workstation using the Terraform CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">$ cd terraform
$ terraform init
$ terraform apply</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploying_from_pipelines"><a class="anchor" href="#_deploying_from_pipelines"></a>Deploying from pipelines</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using pipelines, the DevOps Stack runs a dry-run on Merge Request and applies
the modification on commit on a protected branch.</p>
</div>
<div class="sect2">
<h3 id="_gitlab_ci"><a class="anchor" href="#_gitlab_ci"></a>GitLab CI</h3>
<div class="sect3">
<h4 id="_push_your_code_in_a_new_project_on_gitlab"><a class="anchor" href="#_push_your_code_in_a_new_project_on_gitlab"></a>Push your code in a new project on Gitlab</h4>
<div class="paragraph">
<p>Create a new project on GitLab and push your Terraform files on it.
You can use either gitlab.com or your self hosted GitLab instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="_protect_your_branch"><a class="anchor" href="#_protect_your_branch"></a>Protect your branch</h4>
<div class="paragraph">
<p>The cluster creation pipeline is triggered only on protected branches,
so you have to protect every branch that will define a cluster
(in Settings &#8658; Repository &#8658; Protected Branches).</p>
</div>
</div>
<div class="sect3">
<h4 id="_add_ci_cd_variables"><a class="anchor" href="#_add_ci_cd_variables"></a>Add CI / CD variables</h4>
<div class="paragraph">
<p>There are multiple ways to configure the
<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs">Terraform AWS provider</a>.
You could commit the credentials in your code,
with a high potential risk of secret leakage,
or another simple solution is to define the required environment variables as CI/CD variables.</p>
</div>
<div class="paragraph">
<p>In your project&#8217;s Setting → CI/CD → Variables, add variables for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AWS_ACCESS_KEY_ID</code></p>
</li>
<li>
<p><code>AWS_SECRET_ACCESS_KEY</code></p>
</li>
<li>
<p><code>AWS_REGION</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_create_gitlab_ci_yml"><a class="anchor" href="#_create_gitlab_ci_yml"></a>Create <code>.gitlab-ci.yml</code></h4>
<div class="paragraph">
<p>In order to use Gitlab as Continuous Delivery,
you have to create a <code>.gitlab-ci.yml</code> file in the root level of your project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
include:
  - https://raw.githubusercontent.com/camptocamp/camptocamp-devops-stack/v0.26.0/.gitlab-ci/pipeline.yaml</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_trigger_pipeline"><a class="anchor" href="#_trigger_pipeline"></a>Trigger pipeline</h4>
<div class="paragraph">
<p>The pipeline, and hence the cluster creation,
will be triggered when you push to a protected branch,
but you can trigger a pipeline manually if needed (in CI/CD ⇒ Pipelines ⇒ Run Pipeline).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_github_actions"><a class="anchor" href="#_github_actions"></a>GitHub Actions</h3>
<div class="sect3">
<h4 id="_create_a_new_project_on_github"><a class="anchor" href="#_create_a_new_project_on_github"></a>Create a new project on GitHub</h4>
<div class="paragraph">
<p>Create a new project on GitHub and push your Terraform files on it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_add_actions_secrets"><a class="anchor" href="#_add_actions_secrets"></a>Add Actions secrets</h4>
<div class="paragraph">
<p>There are multiple ways to configure the
<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs">Terraform AWS provider</a>.
You could commit the credentials in your code,
with a high potential risk of leakage,
or another simple solution is to define the required environment variables as Actions secrets.</p>
</div>
<div class="paragraph">
<p>In your project settings in Secrets Actions, create secrets for these variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AWS_ACCESS_KEY_ID</code></p>
</li>
<li>
<p><code>AWS_SECRET_ACCESS_KEY</code></p>
</li>
<li>
<p><code>AWS_REGION</code></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_create_github_actions_workflow_for_your_project"><a class="anchor" href="#_create_github_actions_workflow_for_your_project"></a>Create GitHub Actions workflow for your project</h4>
<div class="paragraph">
<p>Unfortunately, composite Actions have some limitations right now,
so we can&#8217;t provide a single Action to declare in your workflow
(as we do for GitLab pipeline).
Hence, you have to create a <code>.github/workflows/terraform.yml</code> file with this content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
name: 'Terraform'
on:
  push:
    branches:
      - main
  pull_request:
jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      CAMPTOCAMP_DEVOPS_STACK_VERSION: 0.26.0
      TF_ROOT: terraform
    defaults:
      run:
        working-directory: ${{ env.TF_ROOT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
        with:
          terraform_version: 0.14.6

      - name: Terraform Format
        run: terraform fmt -check -diff -recursive

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        if: github.event_name == 'pull_request'
        run: terraform plan -no-color -out plan

      - name: Generate outputs.tf
        if: github.event_name == 'pull_request'
        run: terraform-bin show -json plan | jq -r '.planned_values.outputs' &gt; outputs.json

      - name: ArgoCD app diff with ${{ github.ref }}
        if: github.event_name == 'pull_request'
        uses: docker://argoproj/argocd:v1.7.12
        with:
          entrypoint: ./.github/scripts/app-diff.sh

      - name: Terraform Apply
        if: github.event_name == 'push'
        run: terraform apply --auto-approve

      - name: Terraform Plan
        if: github.event_name == 'push'
        run: terraform plan --detailed-exitcode -no-color

      - name: Generate outputs.tf
        if: github.event_name == 'push'
        run: terraform-bin output -json &gt; outputs.json

      - name: Wait for App of Apps
        if: github.event_name == 'push'
        uses: docker://argoproj/argocd:v1.7.12
        with:
          entrypoint: .github/scripts/wait-for-app-of-apps.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>And these two files in <code>.github/scripts</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>.github/scripts/app-diff.sh</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/sh

set -e

python3 -c "import urllib.request; print(urllib.request.urlopen('https://raw.githubusercontent.com/camptocamp/camptocamp-devops-stack/v$CAMPTOCAMP_DEVOPS_STACK_VERSION/scripts/app-diff.sh').read().decode())" | bash</code></pre>
</div>
</div>
</li>
<li>
<p><code>.github/scripts/wait-for-app-of-apps.sh</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/sh

set -e

python3 -c "import urllib.request; print(urllib.request.urlopen('https://raw.githubusercontent.com/camptocamp/camptocamp-devops-stack/v$CAMPTOCAMP_DEVOPS_STACK_VERSION/scripts/wait-for-app-of-apps.sh').read().decode())" | bash</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recovering_the_kubeconfig_for_eks"><a class="anchor" href="#_recovering_the_kubeconfig_for_eks"></a>Recovering the kubeconfig for EKS</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure your AWS credentials file (<code>~/.aws/credentials</code> on Linux) contains the access key that has been used to create the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ini hljs" data-lang="ini">[&lt;ACCOUNT_NAME&gt;]
aws_access_key_id = &lt;YOUR_ACCESS_KEY_ID&gt;
aws_secret_access_key = &lt;YOUR_SECRET_ACCESS_KEY&gt;
region = &lt;YOUR_REGION&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Update your kubeconfig using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">aws --profile &lt;ACCOUNT_NAME&gt; eks --region &lt;YOUR_REGION&gt; update-kubeconfig --name &lt;CLUSTER_NAME&gt;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Then, you should be able to use <code>kubectl</code>.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/terraform.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
